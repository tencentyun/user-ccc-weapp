var emoji = require('./emojiMap.wxs')

var emojiMap = emoji.emojiMap
var emojiName = emoji.emojiName
var emojiUrl = emoji.emojiUrl

var decodeText = function (message) {
  if(!message || !message.payload || !message.payload.text) {
    return []
  }
  var renderDom = []
  // 文本消息
  var temp = message.payload.text
  var left = -1
  var right = -1

  emojiName.forEach(function(item) {
    temp = temp.split(item).join('「' + item + '」')
  })

  while (temp !== '') {
    left = temp.indexOf('「')
    right = temp.indexOf('」')
    switch (left) {
      case 0:
        if (right === -1) {
          renderDom.push({
            name: 'text',
            text: temp
          })
          temp = ''
        } else {
          var _emoji = temp.slice(1, right)
          if (emoji.emojiMap[_emoji]) {
            renderDom.push({
              name: 'img',
              src: emoji.emojiUrl + emoji.emojiMap[_emoji]
            })
            temp = temp.substring(right + 1)
          } else {
            renderDom.push({
              name: 'text',
              text: '「'
            })
            temp = temp.slice(1)
          }
        }
        break
      case -1:
        renderDom.push({
          name: 'text',
          text: temp
        })
        temp = ''
        break
      default:
        renderDom.push({
          name: 'text',
          text: temp.slice(0, left)
        })
        temp = temp.substring(left)
        break
    }
  }
  return renderDom
}

module.exports.decodeText = decodeText